version: 0.1
phases:
  pre_build:
    commands:
      - env
      - find .
      - aws codepipeline --region us-east-1 get-pipeline-state --name helloworld | jq -c '.stageStates\[\] | select(.actionStates\[\] | .latestExecution.externalExecutionId=="'$CODEBUILD_BUILD_ID'") | .latestExecution.pipelineExecutionId' | xargs aws codepipeline get-pipeline-execution --pipeline-name helloworld --pipeline-execution-id | jq -r -c '.pipelineExecution.artifactRevisions\[0\].revisionId' 
      - printf "%s:%s" "$REPOSITORY_URI" "$(cat .git/refs/heads/master)" > /tmp/build_tag.out
      - printf '{"tag":"%s"}' "$(cat .git/refs/heads/master)" > /tmp/build.json
      - $(aws ecr get-login)
  build:
    commands:
      - docker build -t "$(cat /tmp/build_tag.out)" .
  post_build:
    commands:
      - docker push "$(cat /tmp/build_tag.out)"
      - aws ecr batch-get-image --repository-name $REPOSITORY_NAME --image-ids imageTag=foobar --query 'images[].imageManifest' --output text > /tmp/latest_manifest.json
      - aws ecr put-image --repository-name $REPOSITORY_NAME --image-tag latest --image-manifest (cat /tmp/latest_manifest.json)
artifacts:
  files: /tmp/build.json
  discard-paths: yes
